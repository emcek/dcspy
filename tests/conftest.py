from pathlib import Path
from unittest.mock import MagicMock, patch

from pytest import fixture

import dcspy
from dcspy import aircraft


def generate_fixture(plane_model, lcdtype):
    @fixture()
    def _fixture():
        return plane_model(lcdtype)
    return _fixture


for plane in ['Aircraft', 'FA18Chornet', 'F16C50', 'F15ESE', 'Ka50', 'Ka503', 'Mi8MT', 'Mi24P', 'AH64DBLKII', 'A10C', 'A10C2', 'F14B', 'F14A135GR', 'AV8BNA']:
    for lcd in ['LcdMono', 'LcdColor']:
        airplane = getattr(aircraft, plane)
        lcd_type = getattr(dcspy, lcd)
        name = f'{airplane.__name__.lower()}_{lcd_type.type.name.lower()}'
        globals()[name] = generate_fixture(airplane, lcd_type)


def pytest_addoption(parser) -> None:
    """
    Register img_precision CLI argument.

    :param parser:
    """
    parser.addoption('--img_precision', action='store',  type=int, default=0)


@fixture(scope='session')
def img_precision(pytestconfig):
    """
    Get value of img_precision parameter form command line.

    :param pytestconfig:
    :return: value from command line
    """
    return pytestconfig.getoption('img_precision')


@fixture()
def resources():
    """
    Path to tests/resources directory.

    :return: path to tests/resources directory
    """
    return Path(__file__).resolve().with_name('resources')


# <=><=><=><=><=> dcsbios <=><=><=><=><=>
@fixture
def protocol_parser():
    """Instance of ProtocolParser."""
    from dcspy.dcsbios import ProtocolParser
    return ProtocolParser()


# <=><=><=><=><=> logitech <=><=><=><=><=>
@fixture()
def keyboard_base(protocol_parser):
    """
    Return instance of LogitechKeyboard.

    :param protocol_parser: instance of ProtocolParser
    :return: LogitechKeyboard
    """
    from dcspy.logitech import LogitechKeyboard
    from dcspy.sdk import lcd_sdk
    with patch.object(lcd_sdk, 'logi_lcd_init', return_value=True):
        return LogitechKeyboard(protocol_parser)


@fixture()
def keyboard_mono(protocol_parser):
    """
    Return instance of KeyboardMono.

    :param protocol_parser: instance of ProtocolParser
    :return: KeyboardMono
    """
    from dcspy.logitech import KeyboardMono
    from dcspy.sdk import lcd_sdk
    with patch.object(lcd_sdk, 'logi_lcd_init', return_value=True):
        return KeyboardMono(protocol_parser)


@fixture()
def keyboard_color(protocol_parser):
    """
    Return instance of KeyboardColor.

    :param protocol_parser: instance of ProtocolParser
    :return: KeyboardColor
    """
    from dcspy.logitech import KeyboardColor
    from dcspy.sdk import lcd_sdk
    with patch.object(lcd_sdk, 'logi_lcd_init', return_value=True):
        return KeyboardColor(protocol_parser)


# <=><=><=><=><=> others <=><=><=><=><=>
@fixture()
def sock():
    """Socket mock instance."""
    return MagicMock()


@fixture()
def autoupdate1_cfg():
    """Mock for correct autoupdate_cfg."""
    return """{
 "WARNING": "DO NOT EDIT this file. You may break your install!",
 "branch": "openbeta",
 "version": "2.7.16.28157",
 "timestamp": "20220729-154039",
 "arch": "x86_64",
 "lang": "EN",
 "modules": [
  "WORLD",
  "FA-18C",
  "NS430_MI-8MTV2",
  "NS430",
  "MI-8MTV2",
  "UH-1H",
  "A-10C",
"""


@fixture()
def autoupdate2_cfg():
    """Mock for wrong autoupdate_cfg."""
    return """{
 "WARNING": "DO NOT EDIT this file. You may break your install!",
 "branch": "openbeta",
 "timestamp": "20220729-154039",
 "arch": "x86_64",
 "lang": "EN",
 "modules": [
  "WORLD",
  "FA-18C",
  "NS430_MI-8MTV2",
  "NS430",
  "MI-8MTV2",
  "UH-1H",
  "A-10C",
"""


@fixture()
def autoupdate3_cfg():
    """Mock for wrong autoupdate_cfg."""
    return """{
 "WARNING": "DO NOT EDIT this file. You may break your install!",
 "version": "2.7.18.28157",
 "timestamp": "20220729-154039",
 "arch": "x86_64",
 "lang": "EN",
 "modules": [
  "WORLD",
  "FA-18C",
  "NS430_MI-8MTV2",
  "NS430",
  "MI-8MTV2",
  "UH-1H",
  "A-10C",
"""


@fixture()
def apache_pre_mode_bios_data():
    """Bios values for AH-64D Apache PRE mode."""
    return [
        ('PLT_EUFD_LINE1', 'LOW ROTOR RPM     |RECTIFIER 2 FAIL  |PRESET TUNE VHF   '),
        ('PLT_EUFD_LINE2', 'ENGINE 2 OUT      |GENERATOR 2 FAIL  |!CO CMD   127.000 '),
        ('PLT_EUFD_LINE3', 'ENGINE 1 OUT      |AFT FUEL LOW      | D/1/227  135.000 '),
        ('PLT_EUFD_LINE4', '                  |FORWARD FUEL LOW  | JAAT     136.000 '),
        ('PLT_EUFD_LINE5', '                  |                  | BDE/HIG  127.000 '),
        ('PLT_EUFD_LINE6', '                                     | FAAD     125.000 '),
        ('PLT_EUFD_LINE7', '                                     | JTAC     121.000 '),
        ('PLT_EUFD_LINE8', '~<>VHF*  127.000   -----             | AWACS    141.000 '),
        ('PLT_EUFD_LINE9', ' ==UHF*  305.000   -----             | FLIGHT   128.000 '),
        ('PLT_EUFD_LINE10', ' ==FM1*   30.000   -----    NORM     | BATUMI   126.000 '),
        ('PLT_EUFD_LINE11', ' ==FM2*   30.000   -----             | COMMAND  137.000 '),
    ]


@fixture()
def fa18chornet_mono_bios():
    """Bios values for F/A-18C Hornet for Logitech mono LCD."""
    return [
        ('UFC_SCRATCHPAD_STRING_1_DISPLAY', '11'),
        ('UFC_SCRATCHPAD_STRING_2_DISPLAY', '22'),
        ('UFC_SCRATCHPAD_NUMBER_DISPLAY', '1234567890'),
        ('UFC_OPTION_DISPLAY_1', '1234'),
        ('UFC_OPTION_DISPLAY_2', '2345'),
        ('UFC_OPTION_DISPLAY_3', '3456'),
        ('UFC_OPTION_DISPLAY_4', '4567'),
        ('UFC_OPTION_DISPLAY_5', '5678'),
        ('UFC_COMM1_DISPLAY', '11'),
        ('UFC_COMM2_DISPLAY', '22'),
        ('UFC_OPTION_CUEING_1', '1'),
        ('UFC_OPTION_CUEING_2', '2'),
        ('UFC_OPTION_CUEING_3', '3'),
        ('UFC_OPTION_CUEING_4', '4'),
        ('UFC_OPTION_CUEING_5', '5'),
        ('IFEI_FUEL_DOWN', '123456'),
        ('IFEI_FUEL_UP', '234567'),
    ]


@fixture()
def fa18chornet_color_bios(fa18chornet_mono_bios):
    """Bios values for F/A-18C Hornet for Logitech color LCD."""
    return fa18chornet_mono_bios


@fixture()
def f16c50_mono_bios():
    """Bios values for F16C Viper for Logitech mono LCD."""
    return [
        ('DED_LINE_1', '  INS  08.0/ 6        1a '),
        ('DED_LINE_2', "  LAT *N 43o06.2'*       @"),
        ('DED_LINE_3', "  LNG  E040o34.2'        "),
        ('DED_LINE_4', ' SALT      74FT          '),
        ('DED_LINE_5', ' THDG   25.0o   G/S    0 '),
    ]


@fixture()
def f16c50_color_bios(f16c50_mono_bios):
    """Bios values for F16C Viper for Logitech color LCD."""
    return f16c50_mono_bios


@fixture()
def f15ese_mono_bios():
    """Bios values for F-15ESE Eagle for Logitech mono LCD."""
    return [
        ('F_UFC_LINE1_DISPLAY', '*R2-35     141000-AM'),
        ('F_UFC_LINE2_DISPLAY', 'MARITIME      MAN-'),
        ('F_UFC_LINE3_DISPLAY', ' HQ       AJ PROGRAM'),
        ('F_UFC_LINE4_DISPLAY', 'KY-58       SQUELCH*'),
        ('F_UFC_LINE5_DISPLAY', '*U262000    U133000*'),
        ('F_UFC_LINE6_DISPLAY', ' 10               G '),
    ]


@fixture()
def f15ese_color_bios(f15ese_mono_bios):
    """Bios values for F-15ESE Eagle for Logitech color LCD."""
    return f15ese_mono_bios


@fixture()
def ka50_mono_bios():
    """Bios values for Ka-50 Black Shark II for Logitech mono LCD."""
    return [
        ('PVI_LINE1_APOSTROPHE1', '`'),
        ('PVI_LINE1_APOSTROPHE2', '`'),
        ('PVI_LINE1_POINT', '1'),
        ('PVI_LINE1_SIGN', '-'),
        ('PVI_LINE1_TEXT', '123456'),
        ('PVI_LINE2_APOSTROPHE1', '`'),
        ('PVI_LINE2_APOSTROPHE2', '`'),
        ('PVI_LINE2_POINT', '2'),
        ('PVI_LINE2_SIGN', ' '),
        ('PVI_LINE2_TEXT', '654321'),
        ('AP_ALT_HOLD_LED', 1),
        ('AP_BANK_HOLD_LED', 0),
        ('AP_FD_LED', 1),
        ('AP_HDG_HOLD_LED', 0),
        ('AP_PITCH_HOLD_LED', 1),
    ]


@fixture()
def ka50_color_bios(ka50_mono_bios):
    """Bios values for Ka-50 Black Shark II for Logitech color LCD."""
    return ka50_mono_bios


@fixture()
def ka503_mono_bios(ka50_mono_bios):
    """Bios values for Ka-50 Black Shark III for Logitech mono LCD."""
    return ka50_mono_bios


@fixture()
def ka503_color_bios(ka50_mono_bios):
    """Bios values for Ka-50 Black Shark III for Logitech color LCD."""
    return ka50_mono_bios


@fixture()
def mi8mt_mono_bios():
    """Bios values for Mi-8MTV2 Magnificent Eight for Logitech mono LCD."""
    return [
        ('LMP_AP_HDG_ON', 1),
        ('LMP_AP_PITCH_ROLL_ON', 0),
        ('LMP_AP_HEIGHT_ON', 1),
        ('R863_CNL_SEL', 9),
        ('R863_MOD', 1),
        ('R863_FREQ', '123.525'),
        ('R828_PRST_CHAN_SEL', 9),
        ('YADRO1A_FREQ', '09091.9'),
    ]


@fixture()
def mi8mt_color_bios(mi8mt_mono_bios):
    """Bios values for Mi-8MTV2 Magnificent Eight for Logitech color LCD."""
    return mi8mt_mono_bios


@fixture()
def mi24p_mono_bios():
    """Bios values for Mi-24P Hind for Logitech mono LCD."""
    return [
        ('PLT_R863_CHAN', 9),
        ('PLT_R863_MODUL', 1),
        ('PLT_R828_CHAN', 9),
        ('JADRO_FREQ', '08082.8'),
        ('PLT_SAU_HOVER_MODE_ON_L', 1),
        ('PLT_SAU_ROUTE_MODE_ON_L', 0),
        ('PLT_SAU_ALT_MODE_ON_L', 1),
        ('PLT_SAU_H_ON_L', 0),
        ('PLT_SAU_K_ON_L', 0),
        ('PLT_SAU_T_ON_L', 0),
        ('PLT_SAU_B_ON_L', 1),
    ]


@fixture()
def mi24p_color_bios(mi24p_mono_bios):
    """Bios values for Mi-24P Hind for Logitech color LCD."""
    return mi24p_mono_bios


@fixture()
def ah64dblkii_mono_bios():
    """Bios values for AH-64D Apache for Logitech mono LCD."""
    return [
        ('PLT_EUFD_LINE8', '~<>VHF*  121.000   -----              121.500   -----   '),
        ('PLT_EUFD_LINE9', ' ==UHF*  305.000   -----              305.000   -----   '),
        ('PLT_EUFD_LINE10', ' ==FM1*   30.000   -----    NORM       30.000   -----   '),
        ('PLT_EUFD_LINE11', ' ==FM2*   30.000   -----               30.000   -----   '),
        ('PLT_EUFD_LINE12', ' ==HF *    2.0000A -----    LOW         2.0000A -----   '),
    ]


@fixture()
def ah64dblkii_color_bios(ah64dblkii_mono_bios):
    """Bios values for AH-64D Apache for Logitech color LCD."""
    return ah64dblkii_mono_bios


@fixture()
def a10c_mono_bios():
    """Bios values for A-10C Warthog for Logitech mono LCD."""
    return [
        ('VHFAM_FREQ1', '20'),
        ('VHFAM_FREQ2', 1),
        ('VHFAM_FREQ3', 1),
        ('VHFAM_FREQ4', '30'),
        ('VHFAM_PRESET', ' 1'),
        ('VHFFM_FREQ1', '40'),
        ('VHFFM_FREQ2', 2),
        ('VHFFM_FREQ3', 2),
        ('VHFFM_FREQ4', '50'),
        ('VHFFM_PRESET', ' 1'),
        ('UHF_100MHZ_SEL', '5'),
        ('UHF_10MHZ_SEL', 3),
        ('UHF_1MHZ_SEL', 2),
        ('UHF_POINT1MHZ_SEL', 1),
        ('UHF_POINT25_SEL', '25'),
        ('UHF_PRESET', '01'),
        ('ARC210_FREQUENCY', '123.125'),
        ('ARC210_PREV_MANUAL_FREQ', '234.075'),
    ]


@fixture()
def a10c_color_bios(a10c_mono_bios):
    """Bios values for A-10C Warthog for Logitech color LCD."""
    return a10c_mono_bios


@fixture()
def a10c2_mono_bios(a10c_mono_bios):
    """Bios values for A-10C II Tank Killer for Logitech mono LCD."""
    return a10c_mono_bios


@fixture()
def a10c2_color_bios(a10c_mono_bios):
    """Bios values for A-10C II Tank Killer for Logitech color LCD."""
    return a10c_mono_bios


@fixture()
def av8bna_mono_bios():
    """Bios values for AV-8B N/A Harrier for Logitech mono LCD."""
    return [
        ('UFC_SCRATCHPAD', '123456789012'),
        ('UFC_COMM1_DISPLAY', '11'),
        ('UFC_COMM2_DISPLAY', '22'),
        ('AV8BNA_ODU_1_SELECT', '1'),
        ('AV8BNA_ODU_1_TEXT', '1234'),
        ('AV8BNA_ODU_2_SELECT', '2'),
        ('AV8BNA_ODU_2_TEXT', '2345'),
        ('AV8BNA_ODU_3_SELECT', '3'),
        ('AV8BNA_ODU_3_TEXT', '3456'),
        ('AV8BNA_ODU_4_SELECT', '4'),
        ('AV8BNA_ODU_4_TEXT', '4567'),
        ('AV8BNA_ODU_5_SELECT', '5'),
        ('AV8BNA_ODU_5_TEXT', '5678'),
    ]


@fixture()
def av8bna_color_bios(av8bna_mono_bios):
    """Bios values for AV-8B N/A Harrier for Logitech color LCD."""
    return av8bna_mono_bios


@fixture()
def f14a135gr_mono_bios():
    """Bios values for F-14A-135-GR Tomcat for Logitech mono LCD."""
    return []


@fixture()
def f14a135gr_color_bios(f14a135gr_mono_bios):
    """Bios values for F-14A-135-GR Tomcat for Logitech color LCD."""
    return f14a135gr_mono_bios


@fixture()
def f14b_mono_bios(f14a135gr_mono_bios):
    """Bios values for F-14B Tomcat for Logitech mono LCD."""
    return f14a135gr_mono_bios


@fixture()
def f14b_color_bios(f14a135gr_mono_bios):
    """Bios values for F-14B Tomcat for Logitech color LCD."""
    return f14a135gr_mono_bios
